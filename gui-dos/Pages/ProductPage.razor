@page "/product"

@using System.Collections.Generic
@using gui_dos.Data
@using Microsoft.EntityFrameworkCore;

@inject IDbContextFactory<IsvaerftetDbContext> DbContextFactory
@inject NavigationManager NavMan

<AuthorizeView>
    <Authorized>
        <div class="text-center">
            <MudText Typo="Typo.h2">Produkter</MudText>
            <MudButton Color="Color.Primary" StartIcon="@Icons.Filled.Add" Variant="Variant.Filled" Class="rounded-pill border border-dark" OnClick="productInsert">
                Nyt produkt
            </MudButton>
        </div>
        
        @if (products == null)
        {
            <MudText Typo="Typo.h5">Indlæser produkter fra databasen</MudText>
        }

        @if (products != null && products.Count == 0)
        {
            <MudText Typo="Typo.h5">Ingen produkter i databasen</MudText>
        }

        @if (products != null)
        {
            <div class="d-flex justify-center flex-wrap">
                @foreach (var product in products)
                {
                    <div class="m-2 mud-secondary rounded border border-dark">
                        <ProductCard Product="@product" ShopView="false"/>
                        <div class="d-flex justify-space-between mx-4 mb-4">
                            <MudButton Variant="Variant.Filled" Color="Color.Primary" Class="rounded-pill border border-dark" OnClick="() => productEdit(product)">
                                Rediger
                            </MudButton>
                            <MudButton Variant="Variant.Filled" Color="Color.Primary" Class="rounded-pill border border-dark" OnClick="() => productChangelog(product)">
                                Ændringer
                            </MudButton>
                            <MudButton Variant="Variant.Filled" Color="Color.Primary" Class="rounded-pill border border-dark" OnClick="() => productDelete(product)">
                                Slet
                            </MudButton>
                        </div>
                    </div>
                }
            </div>
        }

    </Authorized>
    <NotAuthorized>
        <LoginDisplay />
    </NotAuthorized>
</AuthorizeView>

@code
{
    private List<Product> products;

    protected override async Task OnInitializedAsync()
    {
        using (var ctx = DbContextFactory.CreateDbContext())
        {
            products = await ctx.Products.ToListAsync();
        }
    }

    private void productInsert() {
        NavMan.NavigateTo("/product/insert");
    }

    private async Task productDelete(Product p)
    {
        using (var ctx = DbContextFactory.CreateDbContext())
        {
            ctx.Products.Remove(p);
            await ctx.SaveChangesAsync();
            products = await ctx.Products.ToListAsync();
        }
    }

    private void productEdit(Product p)
    {
        NavMan.NavigateTo($"/product/edit/{p.ProductId}");
    }

    private void productChangelog(Product p)
    {
        NavMan.NavigateTo($"/product/changelog/{p.ProductId}");
    }
}
