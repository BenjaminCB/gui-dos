@page "/products"
@using System.Collections.Generic
@using BlazorApp.Models
@using BlazorApp.Services
@using BlazorApp.Data
@using Microsoft.EntityFrameworkCore;

@inject IDbContextFactory<IsvaerftetDbContext> DbContextFactory

@inject SqlProductService productService

<h1>Products</h1>

@if (products == null)
{
    <div>
        Loading...
    </div>
}

@if (products != null && products.Count == 0)
{
    <div>
        No products found...
    </div>
}

@if (products != null)
{
    @foreach (var product in products)
    {
        <div @key="product">
            <h3>@product.Title</h3>
            <p>@product.Description</p>
            <img src="@product.Image">
        </div>
    }
}

<div>
    <button @onclick="InsertProduct">
        Add product
    </button>
</div>

@code
{
    private List<Product> products;

    protected override async Task OnInitializedAsync()
    {
        using (var ctx = DbContextFactory.CreateDbContext())
        {
            products = await ctx.Products.ToListAsync();
        }
    }

    private async Task InsertProduct()
    {
        using (var ctx = DbContextFactory.CreateDbContext())
        {
            ctx.Products.Add(new Product()
                {
                    Title = "Kujou Karen",
                    Description = "Learns Haskell",
                    Image = "https://raw.githubusercontent.com/laynH/Anime-Girls-Holding-Programming-Books/master/Haskell/Kujou_Karen_Learns_Haskell.png"
                });
            await ctx.SaveChangesAsync();
        }
    }
}
